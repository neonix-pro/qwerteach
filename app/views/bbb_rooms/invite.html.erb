<% saved_room = BbbRoom.where(:param => @room.param).first %>
<% lesson = saved_room.lesson %>
<% @moi =  current_user.id %>
<% @autre =  (current_user == lesson.teacher) ? lesson.student.id : lesson.teacher.id %>
<script type="text/javascript">

  function ajax_request() {
    $.ajax({
      url: "<%= running_bigbluebutton_room_url(@room, :format => 'json') %>",
      dataType: 'json',
      error: function (xhr_data) {
        $("#meeting_status").html("<request error>.");
        setTimeout(function () {
          ajax_request();
        }, 10000);
      },
      success: function (xhr_data) {
        if (xhr_data.running == 'false') {
          $("#meeting_status").html("La classe n'est pas encore lancée.");
        } else {
          $("#meeting_status").html("La classe est lancée!");
        }
        setTimeout(function () {
          ajax_request();
        }, 10000);
      },
      contentType: 'application/json'
    });
    $.ajax({
      url: "<%= url_for(:controller => 'users', action: 'both_users_online',:user_current => @moi, :user_other => @autre) %>",
      dataType: 'json',
      error: function (xhr_data) {
        console.log(xhr_data.responseText);
        console.log("<%= url_for(:controller => 'users', action: 'both_users_online',:user_current => @moi, :user_other => @autre) %>");
        setTimeout(function () {
          ajax_request();
        }, 10000);
      },
      success: function (xhr_data) {
        if (xhr_data.online == 'true') {
          console.log('online');
          $("#join_link").empty();
          var a = document.createElement('a');
          var linkText = document.createTextNode("Rejoindre la classe");
          a.appendChild(linkText);
          a.title = "Rejoindre la classe";
          a.href = "<%= join_bigbluebutton_room_url(@room) %>";
          document.body.appendChild(a);
          $('#join_link').append()
        } else {
          console.log('offline');
          $("#join_link").empty();
        }
        setTimeout(function () {
          ajax_request();
        }, 10000);
      },
      contentType: 'application/json'
    });
  }

  $(document).ready(function () {
    ajax_request();
  });

</script>
<p> <span id="meeting_status">-</span> (<a href="javascript:ajax_request();">refresh</a>)</p>
<div id="join_link"></div>




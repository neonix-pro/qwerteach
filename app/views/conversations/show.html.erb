<div id="chatbox_<%= @conversation.id %>" class="chatbox chatbox_big list-group-item clearfix">
  <div class="chatboxhead">
    <div class="chatboxtitle">

      <% page_header "Conversation" %>

      <p>Vous êtes en discussion avec
        <%= render 'conversations/participants', conversation: @conversation %>
      </p>
      <span class="typing" hidden><i>Écrit</i> <%= image_tag "typing.gif" %></span>
    </div>
  </div>

  <div class="chatboxcontent chatboxcontent_big">
    <% all_receipts = @conversation.messages %>
    <% first_receipt = all_receipts.first %>
    <% if first_receipt.body != "init_conv_via_chat" %>
        <p><%= render 'messages/message', message: first_receipt %></p>
    <% end %>
    <% allbutfirstreceipts = all_receipts.all[1..-1] %>
    <% allbutfirstreceipts.each do |receipt| %>
        <p><%= render 'messages/message', message: receipt %></p>
    <% end %>
  </div>

  <div class="chatboxinput">
    <span class="seen" hidden><i>Vu</i></span>

    <%= form_tag reply_conversation_path(@conversation), :remote => true, method: :post do %>
        <%= text_area_tag 'body', nil, cols: 3, class: 'form-control chatboxtextarea', placeholder: 'Type something...', required: true, "data-cid" => @conversation.id %>
        <%= submit_tag "Envoyer message", class: 'btn btn-primary' %>
    <% end %>
  </div>
  <%= subscribe_to reply_conversation_path(@conversation) %>
</div>
<script>
  $('#chatbox_<%= @conversation.id %> .chatboxinput').click(function () {
    $.ajax({
      url: "/seen",
      data: {conversation_id: "<%= @conversation.id %>"},
      method: 'post'
    });
  });
</script>
<script>
  var chatbox = $("#chatbox_<%= @conversation.id %> .chatboxcontent");
  chatbox.scrollTop(chatbox[0].scrollHeight);
</script>
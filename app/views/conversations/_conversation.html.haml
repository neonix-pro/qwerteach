.mailbox-conversation{:id => "chatbox_#{conversation.id}", data: {id: conversation.id}}
  .loader.text-center
    %i.fa.fa-spinner.fa-spin.fa-3x.text-green
  .conversation-content
    .show-more.text-center
      = link_to 'voir plus', conversation_show_page_path(conversation, page+1), remote:true, data:{toggle:'loader'}
    = render 'conversations/messages', messages: messages
  .conversation-reply
    = form_tag reply_conversation_path(conversation), id: "conversation_form_#{conversation.id}", method: :post, :remote => true do
      = text_area_tag 'body', nil, cols: 3, class: 'form-control chatboxtextarea', placeholder: 'Ã‰crivez ici...', required: true, "data-cid" => conversation.id
      = submit_tag "Envoyer", class: 'btn btn-green btn-qw'
.mailbox-conversation-details
  .conversation-participants
    - conversation.receipts.group(:receiver_id).each do |r|
      = render 'conversations/conversation_participant', user: r.receiver unless r.receiver == current_user || r.receiver.nil?

= subscribe_to reply_conversation_path(conversation)

:javascript
  PrivatePub.subscribe("#{reply_conversation_path(conversation)}", function(data, channel) {
    var id = "#{conversation.id}";
    var chatbox = $("#chatbox_" + id + " .conversation-content");
    var sender_id = data.sender_id;
    var current_user_id = #{current_user.id};

    $('#chatbox_' + id).find('.seen').hide();
    if (sender_id != current_user_id) {
      chatbox.append(data.message_received);
      chatbox.scrollTop(chatbox[0].scrollHeight);
    } else {
      chatbox.append(data.message_sent);
      $("#chatbox_"+ id +" .chatboxtextarea").val("");
    }
    chatbox.scrollTop(chatbox[0].scrollHeight);
  });
